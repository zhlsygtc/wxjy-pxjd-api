<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.insigma.mvc.dao.train.PXYW_001_003.ApiPersonTrnQuaMapper">
  
     <!-- 学员信息列表查询 -->
	 <select id="getStudentList" parameterType="Student" resultType="Student">
	   select 
	    chc111,
	    aac003,
	    chc003,
	    (select code_name from code_value where code_type='AAC004' and code_value = t.aac004) aac004,
	    (select code_name from code_value where code_type='AAC005' and code_value = t.aac005) aac005,
	    aac002,
	    aae005,
	    to_char(t.ecc064,'yyyy-MM-dd') ecc064,
	    (select code_name from code_value where code_type='CHC002' and code_value = t.chc002) chc002,
	    aac026,
	    isselected,
	    nvl(chc301,0) chc301
	   from hc61 t
	   <where> 
	      aab001 = #{baseinfoid} 
	     <if test="aac002!=null">
	       and t.aac002=#{aac002}
	     </if>
	     <if test="aac003!=null">
	       and t.aac003 like '%'||#{aac003}||'%' 
	     </if>
	     <if test="ecc064_a!=null">
	       and to_char(t.ecc064,'yyyy-MM-dd') &gt;= #{ecc064_a}
	     </if>
	     <if test="ecc064_b!=null">
	       and to_char(t.ecc064,'yyyy-MM-dd') &lt;= #{ecc064_b}
	     </if>
	     <if test="aca111!=null">
           and aca111 = #{aca111}
         </if>
	   </where> 
	 </select>
  
    <!-- 学员内码查询学员信息 -->
	 <select id="getStudentById" parameterType="Student" resultType="Student">
	   select 
		    chc111,
		    aac003,
		    chc003,
		    aac004,
		    aac002,
		    aac005,
		    chc008,
		    aae007,
		    aae015,
		    aae005,
		    aac006,
		    to_char(aac007,'yyyy-MM-dd') aac007_string,
		    chc002,
		    chc030,
		    aca111,
		    aac011,
		    eec357,
		    (select code_describe from code_value where code_value = t.eec357 and code_type = 'AAB301') eec357_s,
		    eec358,
		    (select code_describe from code_value where code_value = t.eec358 and code_type = 'AAB301') eec358_s,
		    aae013,
		    aae006,
		    aac026,
		    aab026,
		    bus_uuid,
		    aab001,
		    (select m.file_rel_path from s_file_record m,s_bus_file_record n where m.file_uuid=n.file_uuid and n.bus_uuid=t.bus_uuid) photo_url
	   from hc61 t
	   <where> 
	      	chc111 = #{chc111} 
	   </where> 
	 </select>
	 
	 <!-- 身份证查询学员信息 -->
	 <select id="getStudentByCardId" parameterType="Hc61_temp" resultType="Student">
 		select * from hc61 t where aac002 = #{aac002} and aab001 = #{baseinfoid} and aae100 = '1'
	 </select>
	 
	 <!-- 查询人员是否已经学员库 -->
	 <select id="getCheckStuInHc61" parameterType="Student" resultType="Student">
	   select 
		    chc111,
		    aac003,
		    chc003,
		    aac004,
		    aac002,
		    aac005,
		    chc008,
		    aae007,
		    aae015,
		    aae005,
		    aac006,
		    to_char(aac007,'yyyy-MM-dd') aac007_string,
		    chc002,
		    chc030,
		    aca111,
		    aac011,
		    eec357,
		    (select code_describe from code_value where code_value = t.eec357 and code_type = 'AAB301') eec357_s,
		    eec358,
		    (select code_describe from code_value where code_value = t.eec358 and code_type = 'AAB301') eec358_s,
		    aae013,
		    aae006,
		    aac026,
		    bus_uuid,
		    aab001,
		    (select m.file_rel_path from s_file_record m,s_bus_file_record n where m.file_uuid=n.file_uuid and n.bus_uuid=t.bus_uuid) photo_url
	   from hc61 t 
	   <where> 
	        aae100 = '1' 
	        <if test="aac002!=null">
		       and aac002=#{aac002}
		    </if>
		    <if test="baseinfoid!=null">
		       and aab001=#{baseinfoid}
		    </if>
	   </where> 
	 </select>
	 
	 <!-- 学员内码查询学员信息中文 -->
	 <select id="getStudentGBKById" parameterType="Student" resultType="Student">
	   select 
		    chc111,
		    aac003,
		    chc003,
		    (select code_name from code_value where code_type='AAC004' and code_value = t.aac004) aac004,
		    aac002,
		    (select code_name from code_value where code_type='AAC005' and code_value = t.aac005) aac005,
		    aae005,
		    to_char(aac006,'yyyy-MM-dd') aac006_string,
		    to_char(aac007,'yyyy-MM-dd') aac007_string,
		    (select code_name from code_value where code_type='CHC002' and code_value = t.chc002) chc002,
		    (select code_name from code_value where code_type='AAC011' and code_value = t.aac011) aac011,
		    (select code_describe from code_value where code_value = t.eec357 and code_type = 'AAB301') eec357,
		    (select code_describe from code_value where code_value = t.eec358 and code_type = 'AAB301') eec358,
		    (select code_name from code_value where code_type='ACA111' and code_value = t.aca111) aca111_s,
		    (select code_name from code_value where code_type='AAC009' and code_value = t.chc008) chc008,
		    (select code_name from code_value where code_type='CHC030' and code_value = t.chc030) chc030,
		    (select name from smt_group where groupid = t.aab001) aab004,
		    aab026,
		    decode(length(t.aac002),'18',(to_char(sysdate,'yyyy')-substr(t.aac002,7,4)),(to_char(sysdate,'yyyy')-('19'||substr(t.aac002,7,2)))) age,
		    aac026,
		    (select code_name from code_value where code_type='CHB210' and code_value = (select chb210 from ca13 where aca111 = t.aca111)) planTime,
		    aae013,
		    to_char(t.aae036,'yyyy&quot;年&quot;MM&quot;月&quot;dd&quot;日&quot;') aae036_s,
		    (case when chc008 = '11' or chc008 = '12' or chc030 is not null then '1' else '0' end) flag,
		    bus_uuid,
		    (select m.file_rel_path from s_file_record m,s_bus_file_record n where m.file_uuid=n.file_uuid and n.bus_uuid=t.bus_uuid) photo_url
	   from hc61 t
	   <where> 
	      	chc111 = #{chc111} 
	   </where> 
	 </select>
  
    <!-- 更新学员信息 -->
	  <update id="updateStu" parameterType="Student">
	    update hc61
	    <set>
	      <if test="aac003 != null">
	        AAC003 = #{aac003,jdbcType=VARCHAR},
	      </if>
	      <if test="chc003 != null">
	        chc003 = #{chc003,jdbcType=VARCHAR},
	      </if>
	      <if test="aac005 != null">
	        aac005 = #{aac005,jdbcType=VARCHAR},
	      </if>
	      <if test="chc002 != null">
	        chc002 = #{chc002,jdbcType=VARCHAR},
	      </if>
	      <if test="chc008 != null">
	        chc008 = #{chc008,jdbcType=VARCHAR},
	      </if>
	      <if test="eec357 != null">
	        eec357 = #{eec357,jdbcType=VARCHAR},
	      </if>
	      <if test="eec358 != null">
	        eec358 = #{eec358,jdbcType=VARCHAR},
	      </if>
	      <if test="aac026 != null">
	        aac026 = #{aac026,jdbcType=VARCHAR},
	      </if>
	      <if test="aae005 != null">
	        aae005 = #{aae005,jdbcType=VARCHAR},
	      </if>
	      <if test="aae007 != null">
	        aae007 = #{aae007,jdbcType=VARCHAR},
	      </if>
	      <if test="aae015 != null">
	        aae015 = #{aae015,jdbcType=VARCHAR},
	      </if>
	      <if test="chc030 != null">
	        chc030 = #{chc030,jdbcType=VARCHAR},
	      </if>
	      <if test="aae006 != null">
	        aae006 = #{aae006,jdbcType=VARCHAR},
	      </if>
	      <if test="aab024 != null">
	        aab024 = #{aab024,jdbcType=VARCHAR},
	      </if>
	      <if test="aab025 != null">
	        aab025 = #{aab025,jdbcType=VARCHAR},
	      </if>
	      <if test="aab026 != null">
	        aab026 = #{aab026,jdbcType=VARCHAR},
	      </if>
	      <if test="chc066 != null">
            chc066 = #{chc066,jdbcType=DATE},
          </if>
	      <if test="aae036 != null">
            aae036 = #{aae036,jdbcType=DATE},
          </if>
          <if test="ecc064_date != null">
            ecc064 = #{ecc064_date,jdbcType=DATE},
          </if>
	      <if test="aac007_string != null">
	        aac007 = to_date(#{aac007_string,jdbcType=VARCHAR},'yyyy-MM-dd'),
	      </if>
	      <if test="aac011 != null">
	        aac011 = #{aac011,jdbcType=VARCHAR},
	      </if>
	      <if test="aca111 != null">
	        aca111 = #{aca111,jdbcType=VARCHAR},
	      </if>
	      <if test="aae013 != null">
	        aae013 = #{aae013,jdbcType=VARCHAR},
	      </if>
	      <if test="isselected != null">
	        isselected = #{isselected,jdbcType=VARCHAR},
	      </if>
	      <if test="bus_uuid != null">
	        bus_uuid = #{bus_uuid,jdbcType=VARCHAR},
	      </if>
	    </set>
	    where chc111 = #{chc111,jdbcType=VARCHAR}
	  </update>  
  
     <insert id="insertExcelTempData" parameterType="Hc61_temp">
		insert into hc61_temp(
	        acc117	,--	导入临时表之导入批次号
			chc066	,--	导入临时表之顺序
			chc061	,--	导入临时表之临时表主键
			aac002	,--	导入临时表之身份证号
			aac003	,--	导入临时表之姓名
			aac005  ,
			chc003  ,
			chc002  ,--	导入临时表之人员类型
			chc008  ,
			eec357  ,
			eec358  ,
			aac026  ,
			aae005  ,
			aae007  ,
			aae015  ,
			aae006  ,
			aab024  ,
			aab025  ,
			aab026  ,
			aab001  ,
			aae014  ,
			chb366	, --	导入临时表之校验状态
			assistid  --    导入协助字段
		)
		values (
		    #{acc117	,jdbcType=VARCHAR},--	导入临时表之导入批次号
		    #{chc066	,jdbcType=INTEGER},--	导入临时表之行数
		    #{chc061	,jdbcType=VARCHAR},--	导入临时表之临时表主键
		    #{aac002	,jdbcType=VARCHAR},--	导入临时表之身份证号
			#{aac003	,jdbcType=VARCHAR},--	导入临时表之姓名
			#{aac005	,jdbcType=VARCHAR},
			#{chc003	,jdbcType=VARCHAR},--	导入临时表之就业失业登记证号码
			#{chc002	,jdbcType=VARCHAR},--	导入临时表之人员类型
			#{chc008	,jdbcType=VARCHAR},
			#{eec357	,jdbcType=VARCHAR},
			#{eec358	,jdbcType=VARCHAR},
			#{aac026	,jdbcType=VARCHAR},--	导入临时表之联系地址
			#{aae005	,jdbcType=VARCHAR},
			#{aae007	,jdbcType=VARCHAR},
			#{aae015	,jdbcType=VARCHAR},
			#{aae006	,jdbcType=VARCHAR},
			#{aab024	,jdbcType=VARCHAR},
			#{aab025	,jdbcType=VARCHAR},
			#{aab026	,jdbcType=VARCHAR},
			#{aab001	,jdbcType=VARCHAR},
			'2'  ,
			'0'  ,--	导入临时表之校验状态
			#{assistid	,jdbcType=VARCHAR} --    导入协助字段
		)
	</insert>
  
    <!-- 校验临时表数据 -->
	<select  id="executeProc" statementType="CALLABLE" parameterType="SysExcelBatch" timeout="3600">
	    {call pkg_hc61_excel_data_imp.dealWith_hc61_temp_imp_update(
	    #{excel_batch_number,mode=IN,jdbcType=INTEGER},
	    #{excel_batch_rt_code,mode=OUT,jdbcType=VARCHAR},
	    #{excel_batch_rt_msg,mode=OUT,jdbcType=VARCHAR}
	    )}
	</select>
  
    <!-- 查询批次号 -->
	<select  id="getExcel_batch_number"  parameterType="Hc61_temp" resultType="java.lang.String">
	    select max(excel_batch_number) from s_excel_batch where excel_batch_aae011 = #{userid} and excel_batch_excel_type = #{excel_batch_excel_type}
	</select>
  
    <!-- 查询用户所属机构内码 -->
    <select  id="getBaseinfoid"  parameterType="java.lang.String" resultType="java.lang.String">
	    select baseinfoid from s_user where userid = #{aae011} 
	</select>
  
    <!-- 导入人员列表查询 -->
	 <select id="getPersonList" parameterType="Hc61_temp" resultType="Hc61_temp">
	   select
	    chc061, 
	    chc066,
	    aac002,
	    aac003,
	    aac005,
	    chc003,
	    chc002,
	    chc008,
	    eec357,
	    eec358,
	    aac026,
	    aae005,
	    aae007,
	    aae015,
	    aae006,
	    aab024,
	    aab025,
	    aab026,
	    aab001,
	    (select code_name from code_value where code_type='CHB366' and code_value = t.chb366) chb366_name,
	    chb366,
	    aae013,
	    aae014,
	    (select code_name from code_value where code_type='AAE014' and code_value = t.aae014) aae014_name
	   from hc61_temp t
	   <where> 
	      1 = 1 
	     <if test="acc117!=null">
	       and t.acc117=#{acc117}
	     </if>
	      order by to_number(t.chc066)
	   </where> 
	 </select>
	 
	 <!-- 导入人员列表查询——转代码 -->
	 <select id="getPersonCodeList" parameterType="Hc61_temp" resultType="Hc61_temp">
	   select
	    chc061, 
	    chc066,
	    aac002,
	    aac003,
	    (select code_value from code_value where code_type = 'AAC005' and code_name = t.aac005) aac005,
        chc003,
        (select code_value from code_value where code_type = 'CHC002' and code_name = t.chc002) chc002,
        (select code_value from code_value where code_type = 'AAC009' and code_name = t.chc008) chc008,
	    eec357,
	    eec358,
	    aac026,
	    aae005,
	    aae007,
	    aae015,
	    aae006,
	    aab024,
	    aab025,
	    aab026,
	    aab001,
	    chb366,
	    aae013,
	    aae014,
	    assistid
	   from hc61_temp t
	   <where> 
	      1 = 1 
	     <if test="acc117!=null">
	       and t.acc117=#{acc117}
	     </if>
	      order by to_number(t.chc066)
	   </where> 
	 </select>
  
     <!-- 查询学院库中接下去的顺序号 -->
	 <select id="getNextNo"  resultType="java.lang.String">
	       select  nvl((max(to_number(chc066))+1),1) from hc61 where aae100 = '1'
	 </select>
  
     <insert id="saveDate" parameterType="Student">
		insert into hc61(
	        chc111	,
	        aac001  ,
	        aac002	,
			aac003	,
			aac006  ,
			aac004  ,
			aac005  ,
			chc003  ,
			chc002  ,
			chc008  ,
			eec357  ,
			eec358  ,
			aac026  ,
			aac011  ,
			aac007  ,
			aae005  ,
			aae007  ,
			aae015  ,
			aae006  ,
			aab024  ,
			aab025  ,
			aab026  ,
			isselected,
			eae052  ,
			chc030  ,
			aae100  ,
			aab001  ,
			aae011  ,
			chc066	,
			aca111  ,
			aae036  ,
			ecc064 
		)
		values (
		    #{chc111	,jdbcType=VARCHAR},
		    #{aac001	,jdbcType=VARCHAR},
		    #{aac002	,jdbcType=VARCHAR},
			#{aac003	,jdbcType=VARCHAR},
			#{aac006    ,jdbcType=DATE},
			#{aac004	,jdbcType=VARCHAR},
			#{aac005	,jdbcType=VARCHAR},
			#{chc003	,jdbcType=VARCHAR},
			#{chc002	,jdbcType=VARCHAR},
			#{chc008	,jdbcType=VARCHAR},
			#{eec357	,jdbcType=VARCHAR},
			#{eec358	,jdbcType=VARCHAR},
			#{aac026	,jdbcType=VARCHAR},
			#{aac011	,jdbcType=VARCHAR},
			to_date(#{aac007_string,jdbcType=VARCHAR},'yyyy-MM-dd'),
			#{aae005	,jdbcType=VARCHAR},
			#{aae007	,jdbcType=VARCHAR},
			#{aae015	,jdbcType=VARCHAR},
			#{aae006	,jdbcType=VARCHAR},
			#{aab024	,jdbcType=VARCHAR},
			#{aab025	,jdbcType=VARCHAR},
			#{aab026	,jdbcType=VARCHAR},
			#{isselected	,jdbcType=INTEGER},
			#{eae052	,jdbcType=INTEGER},
			#{chc030	,jdbcType=INTEGER},
			#{aae100	,jdbcType=VARCHAR},
			#{aab001	,jdbcType=INTEGER},
			#{userid	,jdbcType=INTEGER},
			#{chc066	,jdbcType=INTEGER},
			#{aca111    ,jdbcType=INTEGER},
			sysdate,
			sysdate
		)
	</insert>
  
      <!-- 更新人员信息信息 -->
	  <update id="updatePerson" parameterType="Hc61_temp">
	    update hc61_temp
	    <set>
	      <if test="aae014 != null">
	        aae014 = #{aae014,jdbcType=VARCHAR},
	      </if>
	      
	    </set>
	    where chc061 = #{chc061,jdbcType=VARCHAR}
	  </update>  
     <!-- 通过学员内码删除学员信息 -->
	  <delete id="deleteById" parameterType="java.lang.String">
	    delete from hc61
	    where chc111 = #{chc111,jdbcType=VARCHAR}
	  </delete>
	  
	    <!-- 通过学员内码确认学员信息 -->
	  <delete id="confirmById" parameterType="java.lang.String">
	    update hc61 
	    set chc301='1',
	        chc302=sysdate
	    where chc111 = #{chc111,jdbcType=VARCHAR}
	  </delete>
	  
	  
  
      <!-- 查询培训学员年龄要求 -->
	  <select id="getDemand"  resultType="java.lang.String" parameterType="java.lang.String">
	       select  aaa005 from aa01 where aaa001 = #{param}
	  </select>
  
      <!-- 学员培训信息列表查询 -->
	  <select id="getTrainClasses" parameterType="Student" resultType="Hb68">
		  SELECT T.CHB068,
			  CHB100,
			  TO_CHAR(T.CHB107, 'yyyy-MM-dd') CHB107,
			  TO_CHAR(T.CHB108, 'yyyy-MM-dd') CHB108,
			  (SELECT CODE_NAME
				  FROM CODE_VALUE
				  WHERE CODE_TYPE = 'CHB103'
				  AND CODE_VALUE = T.CHB103) CHB103,
			  (SELECT aaa013
				  FROM v_aa10
				  WHERE aaa100 = 'ACA109'
				  AND aaa102 = T.ACA111) ACA111,
			  (SELECT CODE_NAME
				  FROM CODE_VALUE
				  WHERE CODE_TYPE = 'CHB111'
				  AND CODE_VALUE = T.CHB111) CHB111,
			  T2.CHC014,
			  DECODE(SIGN(NVL(T2.CHC014, 0) - T3.CZC910), -1, '0', '1') CHC014_MARK,
			  T2.CHC019,
			  DECODE(SIGN(NVL(T2.CHC019, 0) - T3.CZC912), -1, '0', '1') CHC019_MARK,
			  T2.CHC016,
			  DECODE(SIGN(NVL(T2.CHC016, 0) - T3.CZC914), -1, '0', '1') CHC016_MARK,
			  T2.CHC018
	  	  FROM HB68 T
	  	  JOIN HC60 T1
			  ON T.CHB068 = T1.CHB068
			  AND t.AAB001 = #{baseinfoid}
			  AND T.AAE100 = '1'
	      	  AND T1.CHC111 = #{chc111}
	   	  	  AND T1.AAE100 = '1'
	  	  LEFT JOIN HC66 T2
			  ON T1.CHC001 = T2.CHC001
	   		  AND T2.AAE100 = '1'
	   	  JOIN ZC13 T3
              ON T3.CZC013 = '1'
	 	  ORDER BY T.CHB107 DESC
	  </select>
      
      <!-- 获取机构培训资质 -->
	  <select id="getAca111List" parameterType="CodeValue" resultType="CodeValue">
		  select 
	          code_name||' '||(select code_name from code_value where code_type = 'CHB210' and code_value = b.chb210) code_name,
	          (select aca013 from ca13 where aca111 = b.aca111 and chb210 = b.chb210) code_value,code_type  
	      	from ad01 t,hb62 b,code_value c
	     	where t.aab001 = #{id}
	     	and t.aab001 = b.aab001
	        and b.aca111 = c.code_seq
	        and c.code_type = 'ACA109'
	        and b.aae100='1'
	  </select>
      
        <!-- 获取机构培训专业 -->
	  <select id="getAca109List" parameterType="CodeValue" resultType="CodeValue">
		 SELECT distinct code_name, code_value, code_type
  			FROM hb62 b, code_value c
 			WHERE b.aab001 = #{id}
  			 AND b.aca111 = c.code_seq
   			 AND c.code_type = 'ACA109'
   			 AND b.aae100='1' 
	  </select>
      
      
</mapper>