<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.insigma.mvc.dao.monitor.PXJG_001_006.QueryAttendanceMapper">
    <!-- 查询开班信息列表 -->
    <select id="getInfoList" parameterType="Hb69DTO" resultType="Hb69DTO">
     select
        p.chb100,
        p.chb068,
        p.chb315,
        (select code_name from code_value where code_type = 'ACA111' and code_value=p.aca111) aca111,
        (select code_name from code_value where code_type = 'CHB103' and code_value=p.chb103) chb103,
        p.chb106,
        to_char(p.chb107, 'yyyy-MM-dd') chb107,
        to_char(p.chb108, 'yyyy-MM-dd') chb108,
        ycqcs, 
        decode(zccq,0,'',zccq) zccq, 
        decode(qjrs,0,'',qjrs) qjrs, 
        decode(cdrc,0,'',cdrc) cdrc, 
        decode(ztrc,0,'',ztrc) ztrc, 
        decode(qqrc,0,'',qqrc) qqrc   
    from
        HB68 p,(SELECT a.chb068,
                count(1) ycqcs,
                SUM(decode(get_class_begin_status(chc001, chb069), '0', 1, 0)) zccq,
                SUM(decode(get_class_begin_status(chc001, chb069), '1', 1, 0)) qjrs,
                SUM(decode(get_class_begin_status(chc001, chb069), '2', 1, 0)) cdrc,
                SUM(decode(get_class_end_status(chc001, chb069), '2', 1, 0)) ztrc,
                SUM(decode(get_class_begin_status(chc001, chb069), '4',
                            decode(get_class_end_status(chc001, chb069), '4', 1,
                                    0), 0)) qqrc
           FROM hb68 a, hb69 b, hc60 c
          WHERE a.chb068 = b.chb068
            AND a.chb068 = c.chb068 and c.eae052 = '1'
            and a.aae100 = '1' 
            and c.aae100='1'
            and b.aae100 = '1'
            and a.aab001 = #{aab001}
	        and b.chb064 is not null
	        <if test="chb100!=null">
	            and a.chb100=#{chb100}
	        </if>
	        <if test="aca111!=null">
	            and a.aca111 = #{aca111}
	        </if>
	        <if test="chb103!=null">
	            and a.chb103 in 
	            <foreach item="item" collection="chb103s" open="(" separator="," close=")">
	            	#{item}
	        	</foreach>
	        </if>
	        <if test="chb107!=null">
	        	and to_char(a.chb107,'yyyy-MM-dd') <![CDATA[>=]]> #{chb107}
	        </if>
	        <if test="chb108!=null">
	        	and to_char(a.chb108,'yyyy-MM-dd') <![CDATA[<=]]> #{chb108}
	        </if>
	        
          GROUP BY a.chb068) q
   WHERE p.chb068 = q.chb068
   order by p.chb315,p.chb100 desc
    </select>



    <select id="getHc60List" parameterType="Hc60DTO" resultType="Hc60DTO">
    select 
      p.chc001,
	  aac003,
	  aac002,
	  (select code_name from code_value where code_type='AAC004' and code_value=aac004) aac004,
	  nvl(floor(months_between(SYSDATE, aac006) / 12),'999') a_aac006,
	  nvl((select code_name from code_value where code_type='CHC002' and code_value=chc002),'-') chc002,
	  nvl((select code_name from code_value where code_type='AAC011' and code_value=aac011),'-') aac011,
	  chc003,
	  aae005,
	  aac026,
	  ecc064,
	  aac001,
	  ycqcs, 
      decode(zccq,0,'',zccq) zccq, 
      decode(qjrs,0,'',qjrs) qjrs, 
      decode(cdrc,0,'',cdrc) cdrc, 
      decode(ztrc,0,'',ztrc) ztrc, 
      decode(qqrc,0,'',qqrc) qqrc   
	from
	  HC60 p, (SELECT a.chb068, c.chc001, COUNT(1) ycqcs,
                 SUM(decode(get_class_begin_status(chc001, chb069), '0', 1, 0)) zccq,
                 SUM(decode(get_class_begin_status(chc001, chb069), '1', 1, 0)) qjrs,
                 SUM(decode(get_class_begin_status(chc001, chb069), '2', 1, 0)) cdrc,
                 SUM(decode(get_class_end_status(chc001, chb069), '2', 1, 0)) ztrc,
                 SUM(decode(get_class_begin_status(chc001, chb069), '4',
                             decode(get_class_end_status(chc001, chb069), '4', 1,
                                     0), 0)) qqrc
            FROM hb68 a, hb69 b, hc60 c
           WHERE a.chb068 = b.chb068
             AND a.chb068 = c.chb068
             and a.chb068=#{chb068}
             and a.aae100 = '1'
             and b.aae100 = '1'
             and c.aae100='1'
             and b.chb064 is not null
           GROUP BY a.chb068, c.chc001) q
	where p.chc001 = q.chc001 and p.eae052 = '1'
	  and p.chb068=#{chb068}
	  order by p.chc066
    </select>
    
    
     <select id="getHb69List" parameterType="Hb69DTO" resultType="Hb69DTO">
		select 
		  t.chb069,
		  t.chb158,
		  to_char(t.chb160,'yyyy-MM-dd') chb160,
		  t.aac003,
		  (select code_name from code_value where code_type = 'CHB065' and code_value = d.chb065) || d.chb063 chb161,
		  (select code_name from code_value where code_type = 'CHB065' and code_value = d.chb065) || 
		  	(select code_name from code_value where code_type = 'CHB163' and code_value =d.chb163) chb163,
		  t.chb167,
		  t.chb186,
		  t.chb109,
		  ycqcs, 
	      decode(zccq,0,'',zccq) zccq, 
	      decode(qjrs,0,'',qjrs) qjrs, 
	      decode(cdrc,0,'',cdrc) cdrc, 
	      decode(ztrc,0,'',ztrc) ztrc, 
	      decode(qqrc,0,'',qqrc) qqrc   
		from 
		  hb69 t,hb64 d,(SELECT a.chb068,b.chb069,
	                count(1) ycqcs,
	                SUM(decode(get_class_begin_status(chc001, chb069), '0', 1, 0)) zccq,
	                SUM(decode(get_class_begin_status(chc001, chb069), '1', 1, 0)) qjrs,
	                SUM(decode(get_class_begin_status(chc001, chb069), '2', 1, 0)) cdrc,
	                SUM(decode(get_class_end_status(chc001, chb069), '2', 1, 0)) ztrc,
	                SUM(decode(get_class_begin_status(chc001, chb069), '4',
	                            decode(get_class_end_status(chc001, chb069), '4', 1,
	                                    0), 0)) qqrc
	           FROM hb68 a, hb69 b, hc60 c
	          WHERE a.chb068 = b.chb068
	            AND a.chb068 = c.chb068
	            and a.aae100 = '1' 
	            and c.aae100='1'
	            and b.aae100 = '1'
	            and b.chb064 is not null
	            and a.chb068 = #{chb068}
	          GROUP BY a.chb068,b.chb069) q
		where t.chb064 = d.chb064
		and t.chb069 = q.chb069
		and t.aae100 = '1'
		and t.chb068 = #{chb068}
	order by t.chb160,t.chb186
    </select>
    
    
     <select id="attendanceQueryList" parameterType="Hb69DTO" resultType="Hb69DTO">
			select 
			  a.chb100,
			  b.chb069,
			  b.chb158,
			  to_char(b.chb160,'yyyy-MM-dd') chb160,
			  c.aac003 aac003_s,
			  b.aac003,
			  c.aac002,
			  b.chb167,
			  b.chb186,
			  b.chb109,
			  get_class_begin_status(c.chc001, b.chb069) cdrc,
		      get_class_end_status(c.chc001, b.chb069) ztrc
		  FROM hb68 a, hb69 b, hc60 c
		 WHERE a.chb068 = b.chb068 and c.eae052 = '1'
		   AND a.chb068 = c.chb068
		    and a.aae100 = '1'
		    and b.aae100 = '1'
		    and c.aae100='1'
		    and b.chb064 is not null
			and a.chb068 = #{chb068}
		order by b.chb160,b.chb186
    </select>
    <!-- 导出现场确认表所需学员信息 -->
	 <select id="getStuForSceneSure" parameterType="Hc60" resultType="Hc60">
	 	select t.*,rownum num from
	 	(select aac003
	 	from hc60
	   <where>
	   		aae100 = '1'
	   	and
	   		chb068 = #{chb068}
	   	order by chc066) t
	   </where> 
	 </select>
</mapper>